# 1回限り表示ページ機能

申し込み・登録後に1度だけ表示されるページを作成できる機能です。ページを閉じると、2回目以降はトップページ（または指定したURL）へ自動でリダイレクトされます。

## 機能概要

- ✅ 管理画面から簡単に設定可能
- ✅ **フォームやページとの関連付けを管理画面で設定（コード不要）**
- ✅ Contact Form 7と自動連携
- ✅ セッションベースで初回アクセスを判定
- ✅ トークン付きURLで安全にアクセス管理
- ✅ リダイレクト先URLをカスタマイズ可能
- ✅ カスタム識別子でJavaScriptから柔軟に使用可能

## 基本的な使い方

### 1. 1回限り表示ページの作成

1. WordPress管理画面で新規固定ページを作成
2. ページタイトルと内容を入力（例: "登録完了"、"お申し込みありがとうございます"）
3. 右サイドバーの「1回限り表示ページ設定」で以下を設定:
   - ☑ 「1回限り表示ページにする」にチェック
   - リダイレクト先URL: 空欄の場合はトップページ
4. ページを公開

### 2. フォームとの関連付け（管理画面で設定）

1. `外観` > `1回限り表示ページ` にアクセス
2. 「フォームとページの関連付け設定」セクションで以下を設定:
   - **関連付けタイプ**を選択:
     - **Contact Form 7**: CF7のフォームと連携
     - **ページ**: 特定のページからのリダイレクト
     - **カスタム識別子**: JavaScriptから独自に制御
3. 送信元を選択（フォームまたはページ）
4. 1回限り表示ページを選択
5. 「関連付けを追加」ボタンをクリック

### 3. Contact Form 7との連携例

管理画面で設定すると、**コード不要**で自動的に連携されます！

1. `外観` > `1回限り表示ページ`
2. 関連付けタイプ: **Contact Form 7**
3. Contact Form 7のフォームを選択
4. 1回限り表示ページを選択
5. 保存

これだけで、フォーム送信後に自動的に1回限りページへリダイレクトされます。

### 4. 動作確認

1. フォームを送信
2. 自動的に1回限り表示ページへリダイレクト
3. ページの内容が表示される
4. ブラウザを閉じるか、URLを直接入力して再アクセス
5. トップページにリダイレクトされることを確認

## 管理画面

### 設定ページ（`外観` > `1回限り表示ページ`）

#### 1. フォームとページの関連付け設定

**関連付けタイプ:**

- **Contact Form 7**: CF7のフォームと連携（自動リダイレクト）
- **ページ**: 特定のページにJavaScript用のヘルパー関数を提供
- **カスタム識別子**: 独自のフォームシステムで使用する識別子を指定

#### 2. 設定済み関連付け一覧

現在設定されている関連付けの一覧が表示されます:
- タイプ（CF7/ページ/カスタム）
- 送信元（フォームIDやページ名）
- リダイレクト先（1回限り表示ページ）
- 作成日
- 削除ボタン

#### 3. 設定済みページ一覧

1回限り表示ページに設定されているすべてのページの一覧:
- ページタイトル
- URL
- リダイレクト先
- トークン付きリンク（コピー可能）

#### 4. セッション管理

テスト用にすべてのセッションをリセットできます。

### ページ編集画面

各ページ・投稿の編集画面の右サイドバーに「1回限り表示ページ設定」が表示されます:

- **1回限り表示ページにする**: チェックを入れると機能が有効化
- **リダイレクト先URL**: 2回目以降のアクセス時のリダイレクト先（空欄=トップページ）
- **トークン付きリンク**: 設定後に表示される、実際にアクセスするためのURL

## 高度な使い方

### ページ指定での使用

管理画面で「ページ」タイプを選択して関連付けると、そのページ専用のJavaScriptヘルパー関数が自動的に提供されます:

```javascript
// カスタムフォーム送信時にリダイレクト
document.getElementById('my-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // フォーム送信処理...
    
    // 成功したら1回限りページへリダイレクト
    window.baizyOneTimePageRedirectFromThisPage();
});

// またはリンクを取得して使用
var thankYouLink = window.baizyOneTimePageLinkForThisPage;
console.log(thankYouLink);
```

### カスタム識別子での使用

管理画面で「カスタム識別子」タイプを選択すると、識別子を指定してリダイレクトできます:

```javascript
// カスタム識別子 "my_custom_form" でリダイレクト
window.baizyOneTimePageRedirect('my_custom_form');

// またはリンクを取得
var link = window.baizyOneTimePageGetLink('my_custom_form');
console.log(link);
```

**使用例（Ajax フォーム）:**

```javascript
jQuery.ajax({
    url: ajaxurl,
    type: 'POST',
    data: formData,
    success: function(response) {
        if (response.success) {
            // 成功時に1回限りページへリダイレクト
            window.baizyOneTimePageRedirect('my_registration_form');
        }
    }
});
```

### ショートコードでリンクを生成

ページや投稿の本文内で使用:

```
[one_time_page_link page_id="123" text="登録完了ページへ" class="btn btn-primary"]
```

**パラメータ:**
- `page_id`: 1回限りページのID（必須）
- `text`: リンクテキスト（省略可、デフォルト: "登録完了ページへ"）
- `class`: CSSクラス（省略可）

### PHPテンプレート内で使用

```php
<?php
$thank_you_link = baizy_one_time_page_link( 123 );
?>
<a href="<?php echo esc_url( $thank_you_link ); ?>" class="btn">
    登録完了ページへ
</a>
```

### カスタムAjax処理で使用

```php
add_action( 'wp_ajax_my_custom_form', 'handle_my_custom_form' );
add_action( 'wp_ajax_nopriv_my_custom_form', 'handle_my_custom_form' );

function handle_my_custom_form() {
    // フォームデータの処理...
    
    // 完了後、1回限りページのURLを返す
    $redirect_url = baizy_one_time_page_link( 123 );
    
    wp_send_json_success( array(
        'redirect_url' => $redirect_url,
    ) );
}
```

## トラブルシューティング

### 何度でもページが表示されてしまう

**原因1: セッションが開始されていない**
- サーバーの設定やプラグインの競合を確認
- `session_start()` エラーがないかログを確認

**原因2: ブラウザのCookieが無効**
- ユーザーにCookieを有効にするよう案内

**解決策:**
管理画面（`外観` > `1回限り表示ページ`）から「すべてのセッションをリセット」を実行

### トークンなしでアクセスしてもページが表示される

**原因: トークンチェックが機能していない**
- ページが「1回限り表示ページ」として正しく設定されているか確認
- ページの編集画面で「1回限り表示ページにする」にチェックが入っているか確認

### リダイレクトループが発生する

**原因: リダイレクト先が自分自身のページ**
- リダイレクト先URLが正しく設定されているか確認
- 空欄にするとトップページにリダイレクトされます

## セキュリティについて

- トークンは20文字のランダム文字列で生成
- セッションベースのため、ブラウザごとに独立
- 不正アクセスは自動的にトップページへリダイレクト
- WordPress標準のセキュリティ機能（nonce、エスケープ）を使用

## テスト方法

### 開発環境でのテスト

1. 管理画面で「すべてのセッションをリセット」を実行
2. フォームを送信して1回限りページへアクセス
3. ブラウザの「シークレットモード」で同じURLにアクセス → リダイレクトされることを確認
4. または、通常モードでブラウザを閉じて再度アクセス

### 本番環境でのテスト

1. テスト用の1回限りページを作成
2. 実際のフォーム送信フローをテスト
3. 問題なければ本番用のページに設定を適用

## ファイル構成

```
app/functions/one_time_page.php        # メイン機能ファイル
sample/one_time_page_examples.php      # 実装例
```

## 関数・ショートコードリファレンス

### PHP関数

#### `baizy_one_time_page_link( $page_id )`

1回限りページへのトークン付きURLを生成

**パラメータ:**
- `$page_id` (int): ページID

**戻り値:**
- (string): トークン付きURL

**例:**
```php
$url = baizy_one_time_page_link( 123 );
echo '<a href="' . esc_url( $url ) . '">こちら</a>';
```

### ショートコード

#### `[one_time_page_link]`

1回限りページへのリンクを生成

**属性:**
- `page_id` (必須): ページID
- `text` (省略可): リンクテキスト
- `class` (省略可): CSSクラス

**例:**
```
[one_time_page_link page_id="123" text="登録完了ページへ" class="btn"]
```

## サポート

その他の使用例は `sample/one_time_page_examples.php` を参照してください。
